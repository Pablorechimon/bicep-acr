---
name: PSRule Bicep Validation

on:
  push:
    branches: [ "feature/PSRule-dev" ]
  workflow_dispatch:

jobs:
  Preview-Bicep-Changes:
    runs-on: windows-latest

    steps:
      # Checkout code  
    - uses: actions/checkout@v2

          # Log into Azure
    - name: Login to Azure  
      uses: azure/login@v1.4.3
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    # - name: Run PSRule
    #   uses: pablorechimon/psrule-bicep@latest-exclusions
    #   with:
    #     inputPath: 'deployment/'
    
    - name: Installing Modules
      run: |
        Install-Module -Repository PSGallery -Name PSRule.Rules.Azure -ErrorAction Stop -Scope CurrentUser -Force
        Install-Module -Repository PSGallery -Name Az.Resources -ErrorAction Stop -Scope CurrentUser -Force
        Install-Module -Repository PSGallery -Name Az.Accounts -ErrorAction Stop -Scope CurrentUser -Force
        Uninstall-AzureRm
      shell: pwsh
      
    - name: Testing
      run: |
        dir
        Get-Module -ListAvailable
        $TestResult = Export-AzRuleData
        $TestResult
        dir
        Write-Host "Running In flight Validation"
        Assert-PSRule -InputPath '.'
        Write-Host "In flight Validation Completes"
      shell: pwsh
